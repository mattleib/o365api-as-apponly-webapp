#o365api-as-apponly-webapp

Пример веб-приложения с авторизацией при помощи учетных данных клиента для доступа к пользователям, почте, календарю и контактам в Office 365 через REST API.

Дополнительные сведения о работе протоколов в этом сценарии см. в статье \[Вызовы между службами с использованием учетных данных клиентов] (http://msdn.microsoft.com/en-us/library/azure/dn645543.aspx).

Дополнительные сведения о службе "только для приложений", также называемой "службой или управляющими программами", в Office 365 см. в соответствующем блоге (http://blogs.msdn.com/b/exchangedev/archive/2015/01/22/building-demon-or-service-apps-with-office-365-mail-calendar-and-contacts-apis-oauth2-client-credential-flow.aspx).

## Как запустить этот пример

Чтобы запустить этот пример требуется:
— Visual Studio 2013;
— подключение к Интернету;
— подписка разработчика на Office 365 (достаточно бесплатной пробной версии).

Вы можете получить подписку разработчика на Office 365, зарегистрировавшись на сайте (https://msdn.microsoft.com/en-us/library/office/fp179924(v=office.15).aspx)


### Шаг 1. Клонирование или скачивание этого репозитория

В оболочке или командной строке выполните:

`git clone https://github.com/mattleib/o365api-as-apponly-webapp`


### Шаг 2\. Регистрация примера в клиенте Azure Active Directory

####Необходимые условия. Создайте сертификат для приложения, как описано в соответствующем блоге (http://blogs.msdn.com/b/exchangedev/archive/2015/01/22/building-demon-or-service-apps-with-office-365-mail-calendar-and-contacts-apis-oauth2-client-credential-flow.aspx)

1. Войдите на [портал управления Azure](https://manage.windowsazure.com).
2. На панели навигации слева щелкните Active Directory.
3. Щелкните клиент каталога, в котором нужно зарегистрировать пример приложения.
4. Откройте вкладку "Приложения".
5. В панели нажмите "Добавить".
6. Нажмите "Добавить приложение, разрабатываемое моей организацией".
7. Введите понятное имя для приложения, например O365AppOnlySample, выберите "Веб-приложение и/или веб-API" и нажмите кнопку "Далее".
8. В качестве URL-адреса входа введите базовый URL-адрес примера, такой как `https://localhost:44321/Home`. 
  - *Примечание*. URL-адрес входа должен заканчиваться словом **"`Home`"**, которое ожидается кодом приложения. 
  - *Примечание*. Убедитесь, что для компонента узла используется правильный порт IIS Express SSL, который понадобится позднее для запуска и отладки примера.
9. В URI идентификатора приложения введите `https://<имя_вашего_клиента>/O365AppOnlySample`, заменив `<имя_вашего_клиента>` именем клиента Azure AD. Для завершения регистрации нажмите кнопку "ОК".
10. На портале Azure откройте вкладку "Настройка" для приложения.
11. Найдите значение идентификатора клиента и скопируйте его. Оно потребуется позднее при настройке приложения.
12. Настройте следующие разрешения приложений для веб-приложения:
  - В разделе "Разрешения для других приложений" выберите **"Windows Azure Active Directory"** 
  - В раскрывающемся списке "Разрешения приложений" для "Windows Azure Active Directory" установите флажок **"Чтение данных каталога"**
  - Выберите "Добавить приложение" и добавьте **"Office 365 Exchange Online"**
  - В раскрывающемся списке "Разрешения приложений" для "Office 365 Exchange Online" установите флажок **"Чтение сообщений пользователей"**
  - В раскрывающемся списке "Разрешения приложений" для "Office 365 Exchange Online" установите флажок **"Чтение календарей пользователей"**
  - В раскрывающемся списке "Разрешения приложений" для "Office 365 Exchange Online" установите флажок **"Чтение контактов пользователей"**
13. Сохраните настройку, чтобы просмотреть значение ключа.
14. Настройте общий сертификат X.509, как описано в соответствующем блоге (http://blogs.msdn.com/b/exchangedev/archive/2015/01/22/building-demon-or-service-apps-with-office-365-mail-calendar-and-contacts-apis-oauth2-client-credential-flow.aspx).


### Шаг 3\. Настройка примера

1. Откройте решение в Visual Studio 2013.
2. Откройте файл `web.config`.
3. Найдите значение ключа приложения `RedirectUriLocalHost` и замените его значением из шага 2.
4. Найдите ключ приложения `ClientId` и замените его значение идентификатором клиента из шага 2.
5. Найдите ключ приложения `ClientCertificatePfx` и замените его значение расположением, в котором находится ваш сертификат X.509 с закрытым ключом.
6. Найдите ключ приложения `ClientCertificatePfxPassword` и замените его значение паролем вашего сертификата X.509 с закрытым ключом.
7. Настройте для проекта требование SSL и убедитесь, что начальный URL-адрес настроен на протокол SSL следующим образом:
а) в области свойств проекта параметру "SSL включен" присвоено значение true;
b) в области свойств проекта убедитесь, что URL-адрес SSL соответствует компоненту узла URL-адреса входа, как указано в шаге 2;
c) в редакторе параметров проекта: присвойте начальному URL-адресу значение, указанное на предыдущем шаге.
	


### Шаг 4\. Запуск примера

Вновь соберите решение и запустите его. Рекомендуется проверить в свойствах решения, что запуску соответствует ваш URL-адреса входа "https", указанный на шаге 2.

Изучите пример, войдя с помощью клиента для разработчиков Office 365, выберите почтовый ящик (вы можете захотеть создать дополнительные почтовые ящики и заполнить их данными на портале администрирования Office 365) и извлеките данные.



